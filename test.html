import { Component, OnInit } from '@angular/core';
import { Router } from '@angular/router';
import { ColDef, GridApi, GridOptions } from 'ag-grid/main';
import { MatDialog, MatSnackBar } from '@angular/material';
import { ConfirmDialogComponent } from '../../../shared/dialogs/confirm-dialog.component';
import { Qrepricing_valuation } from '../../../models/qrepricing_valuation';
import { RepricingService } from '../../../services/repricing.service';
import { forkJoin } from 'rxjs';
import {qrepricing_valuation_update_payload} from '../../../models/qrepricing_valuation_update_payload';
import { UserStore } from '../../../stores/user.store';
import {FSC_Q_Repricing_Statuses, PayloadForActionLog, ValuationPageTeam} from '../../../models/qrepricing';
import { CurrentQuarterSessionService } from '../../../services/currentquarter-session.service';
import { Quarter } from '../../../models/quarter';
import {RepricingConstants} from '../../repricing-constants';

enum RowViewType {
  QRepricINGVALUATIONMAPPING = 'QRepricingValuationMapping'
}

enum RowState {
  NEW = 'New',
  UPDATED = 'Updated',
  EXISTING = 'Existing'
}
class RowView<T> {
  state: RowState;
  data: T;
  type: RowViewType;
}

@Component({
  // sselector: 'app-psv',
  templateUrl: './repricing-data-validation.component.html',
  styleUrls: ['./repricing-data-validation.component.css']
})

export class RepricingValidationComponent implements OnInit {
  isLoading = false;
  changesAreSaved: boolean;
  securityPageType: string;
  rowData: RowView<Qrepricing_valuation>[];
  gridOptions: GridOptions;
  isDataPreparationComplete = false;
  columnDefs: ColDef[];
  gridApi: GridApi;
  payload: qrepricing_valuation_update_payload;
  newquarter: Quarter;
  ValuationDate: string;
  readonly allowableStates: string[] = [RepricingConstants.DATA_PREPARATION_COMPLETED, RepricingConstants.DATA_VALIDATION_IN_PROGRESS, RepricingConstants.DATA_VALIDATION_COMPLETED, RepricingConstants.DATA_ANALYSIS_IN_PROGRESS, RepricingConstants.DATA_ANALYSIS_COMPLETED, RepricingConstants.EXPORT_IN_PROGRESS
    , RepricingConstants.EXPORT_COMPLETED, RepricingConstants.REVIEW_IN_PROGRESS, RepricingConstants.REJECTED];

  constructor(
    private discardChangesDialog: MatDialog,
    private QRepricingValuationService: RepricingService,
    private snackBar: MatSnackBar,
    private userStore: UserStore,
    public currentQuarterSessionService: CurrentQuarterSessionService,
    private repricingService: RepricingService,
    private router: Router,
  ) {

    this.changesAreSaved = true;
    this.newquarter = this.currentQuarterSessionService.getCurrentQuarterSession();
    this.ValuationDate =  this.newquarter == null ? null : this.newquarter.currentQuarterEndDate;
    this.gridOptions = <GridOptions>{
      enableFilter: true,
      enableSorting: true,
      animateRows: true,
      enableColResize: true,

      suppressCellSelection: false,
      rowSelection: 'single',

      suppressAggFuncInHeader: true,
      enableCellChangeFlash: true,
      enableStatusBar: true,
      alwaysShowStatusBar: true,
      headerHeight: 50,
      pagination: true,
      paginationPageSize: 2000,
      paginationAutoPageSize: false,
      onGridReady: () => {
        // this.gridOptions.api.sizeColumnsToFit();
      },
      onCellValueChanged: (params)  => {
        this.roweditedChanged(params);
        this.saveChanges();
      },
    };

    this.columnDefs = [
      { headerName: 'Portfolio Position', field: 'data.portfolioPositionID', width: 150, checkboxSelection: false, pinned: 'left' },
      { headerName: 'Ticker', field: 'data.tickerSR', width: 150 },
      { headerName: 'Deal Name', field: 'data.dealName', width: 150, sort: 'asc', pinned: 'left' },
      { headerName: 'Position Name', field: 'data.position', width: 150 },
      { headerName: 'Local Cost', field: 'data.cost', width: 150, valueFormatter: params => this.currencyFormatter(params.value, '$'), filter: 'agNumberColumnFilter', filterParams: {suppressAndOrCondition: true, filterOptions: ['greaterThan']}  },
      { headerName: 'Local Fair Value', field: 'data.fairValue', width: 150, valueFormatter: params => this.currencyFormatter(params.value, '$'), filter: 'agNumberColumnFilter', filterParams: {suppressAndOrCondition: true, filterOptions: ['greaterThan']}  },
      { headerName: 'Public or Private Security Page', field: 'data.publicOrPrivateSecurityPage', width: 150 },
      { headerName: 'Issuer Page Public or Private', field: 'data.issuerPagePublicOrPrivate', width: 150 },
      { headerName: 'Creation Date', field: 'data.creationDate', width: 150 },
      { headerName: 'Deal Currency', field: 'data.cur', width: 150 },
      { headerName: 'CPP Closing Date', field: 'data.cppclosingDate', width: 150 },
      { headerName: 'Position Comment', field: 'data.positionComment', width: 150 },
      { headerName: 'Record Identifier', field: 'data.recordIdentifier', width: 150 },
      { headerName: 'Closing Price', field: 'data.closingPrice', width: 150, valueFormatter: params => this.currencyFormatter(params.value, '$'), filter: 'agNumberColumnFilter', filterParams: {suppressAndOrCondition: true, filterOptions: ['greaterThan']}  },
      { headerName: 'Last Quarter Price', field: 'data.priorQuarterPrice', width: 150 , valueFormatter: params => this.currencyFormatter(params.value, '$'), filter: 'agNumberColumnFilter', filterParams: {suppressAndOrCondition: true, filterOptions: ['greaterThan']} },
      { headerName: 'Equity Split date', field: 'data.equitySplitDate', width: 150 },
      { headerName: 'Market Status', field: 'data.marketStatus', width: 150 },
      { headerName: 'Change in Price last 3 months', field: 'data.percentChangeLast3Months', width: 150, valueFormatter: params => this.percentFormatter(params.value, '%'), filter: 'agNumberColumnFilter', filterParams: {suppressAndOrCondition: true, filterOptions: ['greaterThan']}  },
      { headerName: 'Validate', field: 'data.validateRecommend', width: 150, editable : true, cellEditor: 'agSelectCellEditor', cellEditorParams : {
          values: ['Funds not included in current quarter valuations allocation', 'Issuer should be marked as realized', 'Position comment is Do Not Reprice', 'Company created in current quarter', 'Missing last quarter price (missing stock price)', '% Change in price >40%', 'CAD change in value >$5M', 'Exclude from public repricing as per reviewer', 'Issuer closed past quarter with no last Q price'] },
        cellStyle: function(params) { if (params.value === 'Missing last quarter price (missing stock price)') return {'background-color': 'lightblue'}; else { if (params.value === 'Company created in current quarter') return {'background-color': 'lightyellow'}; else { return {'background-color': '#E2EFDA'}; }} }},
      { headerName: 'Action', field: 'data.actionRecommend', width: 150, cellStyle: {'background-color': '#E2EFDA'}, editable : true, cellEditor: 'agSelectCellEditor', cellEditorParams : {
          values: ['Do not reprice', 'Reprice' ]}},
      { headerName: 'Comments', field: 'data.validateComments', width: 150, cellStyle: {'background-color': '#E2EFDA'}, editable : true, cellEditor: 'agLargeTextCellEditor' }

    ];
  }

  currencyFormatter(currency, sign) {
    if (currency === null || currency === undefined || currency === '') { return currency;
    } else if (currency === 0) { return '$' + currency; } else {
      const sansDec = parseFloat(currency).toFixed(2);
      const formatted = sansDec.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return  '$' + formatted;
    }}

  percentFormatter(currency, sign) {
    if (currency === null || currency === undefined || currency === '') { return currency;
    } else if (currency === 0) { return currency + '%'; } else {
      const sansDec = parseFloat(currency).toFixed(2);
      const formatted = sansDec.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return  formatted + '%';
    }}

  onGeneralSearchChanged(val) {
    if (this.gridOptions && this.gridOptions.api) {
      this.gridOptions.api.setQuickFilter(val);
    }
  }
  roweditedChanged(params) {
    // this.saveChanges1(params.node.data);
    const data = params.node.data;
    if (data.type === RowViewType.QRepricINGVALUATIONMAPPING) {
      const row: RowView<Qrepricing_valuation> = data;
      if (row.state === RowState.EXISTING) {
        row.state = RowState.UPDATED;
        const index = this.rowData.findIndex(u => u.data.portfolioPositionID == row.data.portfolioPositionID);
        if (index >= 0) {
          this.rowData.splice(index, 1);
          this.rowData.push(row);
        }
      }
    }

    this.listsUpdated();
  }


  onDownloadButtonClicked() {
    this.gridOptions.api.exportDataAsCsv({
      fileName: `List of Public Security Valuation`
    });
  }

  onGridReady(params) {
    // let rowData1 = [];
    this.gridApi = params.api;
    this.gridApi.setSortModel([{ colId: 'data.validateRecommend', sort: 'desc' }]);
    this.gridApi.setRowData(this.rowData);
    // this.gridApi.sizeColumnsToFit();
  }
  onActionChanged(rowNode: any, rowData: any, originalValue: any) {
    const updatedData = {...rowNode.data};
    const rowId = rowNode.data.id;
    const rowIndex = rowNode.rowIndex;
    const noChange = false;
    alert(updatedData);
  }
/*
  discardChanges() {
    const discardChangesDialogRef = this.discardChangesDialog.open(ConfirmDialogComponent, {
      data: {
        title: ' ',
        body: 'Are you sure you want to discard the changes?',
        yesButton: {
          hideButtonIcon: true
        },
        noButton: {
          hideButtonIcon: true
        }
      }
    });

    discardChangesDialogRef.afterClosed().subscribe(result => {
      if (result) {
        location.reload();
      }
    });
  }
*/


  listsUpdated() {
    this.changesAreSaved = false;
  }
  saveChanges() {
    this.changesAreSaved = true;
    const neworupdatedList1 = this.rowData.filter(d => d.state === RowState.UPDATED || d.state === RowState.NEW).map(u => u.data);

    forkJoin(
      this.QRepricingValuationService.saveValuationRec(neworupdatedList1)
    ).subscribe(
      () => {
        this.snackBar.open('All changes were successfully updated', null, {
          duration: 3000,
        });
        // this.reloaddata();
      },
      () => {
        this.snackBar.open(
          'An error happened while updating the changes. ' + 'If it persists please contact the administrator',
          'OK'
        );
        this.changesAreSaved = false;
      }
    );
  }


  onGeneralSearchGrid(val) {

    if (this.gridOptions && this.gridOptions.api) {
      this.gridOptions.api.setQuickFilter(val);
    }
  }

  submitForPageAndAction(action: string): void {
    this.isLoading = true;
    const payload = new ValuationPageTeam();
    payload.pageName = 'Data Validation';
    payload.action = action;
    payload.reportType = 'Quarterly';
    payload.status = 'Data Validation Completed';
    this.repricingService.submitWithPageAndAction(payload).subscribe(
      (data: any) => {
        this.isLoading = false;
        console.log('Inside submitForApproval');
        const okMessage = this.snackBar.open('Data Validation Step is Complete', 'OK', { panelClass: ['blue-snackbar'] });
        okMessage.onAction().subscribe(() => {
          this.router.navigateByUrl('/qrepricing/analysis');
        });
      },
      () => {},
      () => {}
    );
  }

  ngOnInit() {

    this.repricingService.getQRepricingStatus().subscribe((data: FSC_Q_Repricing_Statuses) => {
        if (data && data.status) {
          const currentStatus = data.status;
          console.log('current q repricing status: ' + data);

          if (this.allowableStates.includes(currentStatus)) {
            this.isDataPreparationComplete = true;
            this.QRepricingValuationService.getQRepricingValuation(this.ValuationDate).subscribe((data: Qrepricing_valuation[]) => {
              this.rowData = data.map(u => {
                return {
                  data: u,
                  state: RowState.EXISTING,
                  type: RowViewType.QRepricINGVALUATIONMAPPING
                };
              });
            });
          } else {
            this.isDataPreparationComplete = false;
            this.snackBar.open(
              'Data Preparation is not complete. Please complete tasks in Data Preparation to continue',
              'OK'
            );
          }
        }
      },
      () => {
      },
      () => {
      });
  }

}
<div style="margin-bottom:6rem;">
    <mat-card class="mat-elevation-z8">
        <mat-card-content>
            <div style="float:right">
                <button mat-mini-fab color="accent" matTooltip="Submit Valuation Results" (click)="submitForPageAndAction('Submitted')" [disabled]="!isDataPreparationComplete" >
                <mat-icon aria-label="Submit Valuation Results">done_all</mat-icon>
                </button>
               </div>
            <div style="margin-bottom:3rem;">
                <h5>Public Security Data Validation</h5>
                <form>

                    <mat-form-field class="searchUser">
                        <i class="fa fa-search"><input type="text" matInput placeholder="&nbsp;&nbsp; &nbsp; search for ...." (input)="onGeneralSearchGrid($event.target.value)"></i>

                    </mat-form-field>

                </form>
                <button class="download-button"
                        type="button"
                        (click)="onDownloadButtonClicked()">Download Results</button>
                        <br><br>
                <mat-card class="mat-elevation-z1" class="table-container">
                    <ag-grid-angular #agGrid style="width: 100%; height: 450px;" class="ag-theme-balham"
                        [gridOptions]="gridOptions"
                        [columnDefs]="columnDefs"
                        [rowData]="rowData"
                        (gridReady)="onGridReady($event)">
                    </ag-grid-angular>
                </mat-card>
            </div>
        </mat-card-content>
    </mat-card>
<!--
    <mat-toolbar class="control-toolbar mat-elevation-z4">
        <span style="flex: 1 1 auto;"></span>
        <button mat-button color="primary" (click)="saveChanges()" [disabled]="changesAreSaved" class="control-button">Save</button>
        <button mat-button (click)="discardChanges()" [disabled]="changesAreSaved" class="control-button">Discard Changes</button>
    </mat-toolbar>
-->
</div>

    
